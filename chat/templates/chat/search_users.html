{% extends 'base.html' %}
{% load friendship_filters %}
{% block title %}Search Users - ChatApp{% endblock %}

{% block content %}
<div class="row">
    <!-- Search Header -->
    <div class="col-12 mb-4">
        <div class="card card-custom">
            <div class="card-body">
                <h2 class="mb-3">
                    <i class="fas fa-search me-2"></i>Find Users
                </h2>
                <form method="GET" class="row g-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control form-control-lg" 
                                   name="q" value="{{ query }}" 
                                   placeholder="Search by username or email..."
                                   autocomplete="off">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-custom btn-lg w-100">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if query %}
<div class="row">
    <div class="col-12">
        <div class="card card-custom">
            <div class="card-header bg-transparent border-0">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Search Results for "{{ query }}"
                </h5>
            </div>
            <div class="card-body">
                {% if users %}
                    <div class="row">
                        {% for search_user in users %}
                        <div class="col-lg-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-start">
                                        <div class="position-relative me-3">
                                            {% if search_user.profile.profile_photo %}
                                                <img src="{{ search_user.profile.profile_photo.url }}" 
                                                     class="user-avatar" alt="Avatar">
                                            {% else %}
                                                <div class="user-avatar bg-secondary d-flex align-items-center justify-content-center text-white">
                                                    {{ search_user.username|first|upper }}
                                                </div>
                                            {% endif %}
                                            {% if search_user.profile.online %}
                                                <span class="position-absolute top-0 start-100 translate-middle p-1 bg-success border border-light rounded-circle">
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                {{ search_user.get_full_name|default:search_user.username }}
                                                <small class="text-muted">@{{ search_user.username }}</small>
                                            </h6>
                                            
                                            {% if search_user.profile.bio %}
                                                <p class="text-muted small mb-2">
                                                    {{ search_user.profile.bio|truncatechars:80 }}
                                                </p>
                                            {% endif %}
                                            
                                            <div class="mb-2">
                                                {% if search_user.profile.location %}
                                                    <small class="text-muted">
                                                        <i class="fas fa-map-marker-alt me-1"></i>{{ search_user.profile.location }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                            
                                            <small class="text-muted">
                                                {% if search_user.profile.online %}
                                                    <i class="fas fa-circle text-success me-1"></i>Online now
                                                {% else %}
                                                    <i class="fas fa-clock me-1"></i>Last seen {{ search_user.profile.last_activity|timesince }} ago
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3 d-flex justify-content-between align-items-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'user_profile' search_user.id %}" 
                                               class="btn btn-outline-primary">
                                                <i class="fas fa-user me-1"></i>Profile
                                            </a>
                                            <a href="{% url 'private_chat' search_user.id %}" 
                                               class="btn btn-primary">
                                                <i class="fas fa-comment me-1"></i>Chat
                                            </a>
                                        </div>
                                        
                                        <!-- Friend Request Button -->
                                        <div id="friend-action-{{ search_user.id }}">
                                            {% with friendship_status=search_user.id|get_friendship_status:user.id %}
                                                {% if friendship_status == 'accepted' %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>Friends
                                                    </span>
                                                {% elif friendship_status == 'pending_sent' %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-clock me-1"></i>Request Sent
                                                    </span>
                                                {% elif friendship_status == 'pending_received' %}
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-success btn-sm" 
                                                                onclick="respondToFriendRequest('{{ search_user.id }}', 'accept')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button class="btn btn-danger btn-sm" 
                                                                onclick="respondToFriendRequest('{{ search_user.id }}', 'reject')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                {% else %}
                                                    <button class="btn btn-outline-success btn-sm" 
                                                            onclick="sendFriendRequest('{{ search_user.id }}')">
                                                        <i class="fas fa-user-plus me-1"></i>Add Friend
                                                    </button>
                                                {% endif %}
                                            {% endwith %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No users found matching "{{ query }}"</p>
                        <p class="text-muted small">Try searching with a different username or email</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if not query %}
<!-- Recent Users or Suggestions -->
<div class="row">
    <div class="col-12">
        <div class="card card-custom">
            <div class="card-body text-center py-5">
                <i class="fas fa-search fa-4x text-muted mb-4"></i>
                <h4 class="text-muted mb-3">Start searching for users</h4>
                <p class="text-muted mb-4">
                    Enter a username or email in the search box above to find and connect with other users.
                </p>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-lightbulb text-warning me-2"></i>Search Tips
                                </h6>
                                <ul class="list-unstyled text-start small">
                                    <li><i class="fas fa-check text-success me-2"></i>Search by exact username</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Search by email address</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Partial matches are supported</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Search is case-insensitive</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function sendFriendRequest(userId) {
    const button = $(`#friend-action-${userId} button`);
    const originalHTML = button.html();
    
    // Show loading state
    button.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);
    
    $.post('{% url "send_friend_request" %}', {
        'user_id': userId
    }, function(response) {
        if (response.success) {
            // Update UI to show request sent
            $(`#friend-action-${userId}`).html(`
                <span class="badge bg-warning">
                    <i class="fas fa-clock me-1"></i>Request Sent
                </span>
            `);
            showNotification('Friend request sent!', 'success');
        } else {
            // Reset button state
            button.html(originalHTML).prop('disabled', false);
            showNotification('Error: ' + response.message, 'error');
        }
    }).fail(function() {
        // Reset button state
        button.html(originalHTML).prop('disabled', false);
        showNotification('Network error. Please try again.', 'error');
    });
}

function respondToFriendRequest(userId, action) {
    const container = $(`#friend-action-${userId}`);
    const button = container.find('button').first();
    
    // Show loading state
    container.html('<div class="loading-spinner"></div>');
    
    // Find the friendship ID (this would need to be passed from the template)
    // For now, we'll use a simplified approach
    $.post('{% url "respond_friend_request" %}', {
        'user_id': userId,
        'action': action
    }, function(response) {
        if (response.success) {
            if (action === 'accept') {
                container.html(`
                    <span class="badge bg-success">
                        <i class="fas fa-check me-1"></i>Friends
                    </span>
                `);
                showNotification('Friend request accepted!', 'success');
            } else {
                container.html(`
                    <button class="btn btn-outline-success btn-sm" 
                            onclick="sendFriendRequest('${userId}')">
                        <i class="fas fa-user-plus me-1"></i>Add Friend
                    </button>
                `);
                showNotification('Friend request rejected!', 'success');
            }
        } else {
            showNotification('Error: ' + response.message, 'error');
        }
    }).fail(function() {
        showNotification('Network error. Please try again.', 'error');
    });
}

function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 100px; right: 20px; z-index: 9999;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('body').append(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 3000);
}

// Auto-focus search input
$(document).ready(function() {
    $('input[name="q"]').focus();
});

// Search on Enter key
$('input[name="q"]').on('keypress', function(e) {
    if (e.which === 13) {
        $(this).closest('form').submit();
    }
});
</script>
{% endblock %}