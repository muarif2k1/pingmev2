{% extends 'base.html' %}

{% block title %}{{ room.name }} - ChatApp{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card card-custom">
            <!-- Room Header -->
            <div class="card-header bg-transparent border-0">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <a href="{% url 'room_list' %}" class="btn btn-outline-secondary btn-sm me-3">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <div class="me-3">
                            <!-- Fixed: Use conditional classes instead of inline CSS variables -->
                            <div class="rounded-circle d-flex align-items-center justify-content-center text-white room-icon {% if room.is_private %}room-icon-private{% else %}room-icon-public{% endif %}" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas {% if room.is_private %}fa-lock{% else %}fa-hashtag{% endif %} fs-4"></i>
                            </div>
                        </div>
                        <div>
                            <h4 class="mb-0">
                                {{ room.name }}
                                {% if room.is_private %}
                                    <i class="fas fa-lock text-warning ms-2"></i>
                                {% endif %}
                            </h4>
                            <p class="text-muted mb-0">
                                {{ room.description|default:"No description" }}
                            </p>
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>Created by {{ room.creator.username }} â€¢ 
                                <i class="fas fa-users me-1"></i>{{ room.participants.count }} members
                            </small>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cog"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#membersModal">
                                <i class="fas fa-users me-2"></i>View Members
                            </a></li>
                            {% if participant.role == 'admin' or room.creator == user %}
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#inviteUsersModal">
                                <i class="fas fa-user-plus me-2"></i>Invite Users
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            {% endif %}
                            {% if room.creator == user %}
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteRoom()">
                                <i class="fas fa-trash me-2"></i>Delete Room
                            </a></li>
                            {% else %}
                            <li><a class="dropdown-item text-warning" href="#" onclick="leaveRoom()">
                                <i class="fas fa-sign-out-alt me-2"></i>Leave Room
                            </a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="card-body p-0">
                <div id="messages-container" class="chat-container" style="height: 500px;">
                    <div id="loading-indicator" class="text-center py-3" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Loading more messages...
                    </div>
                    
                    {% if chat_messages %}
                        {% load humanize %}
                        {% for message in chat_messages %}
                            {% ifchanged message.timestamp.date %}
                                <div class="date-header">
                                    <span class="date-label">
                                        {% if message.timestamp.date == today %}
                                            Today
                                        {% elif message.timestamp.date == yesterday %}
                                            Yesterday
                                        {% else %}
                                            {{ message.timestamp|date:"F d, Y" }}
                                        {% endif %}
                                    </span>
                                </div>
                            {% endifchanged %}
                            
                            <div class="message-bubble {% if message.user == user %}message-own{% else %}message-other{% endif %} {% if message.is_deleted %}message-deleted{% endif %}" 
                                 data-message-id="{{ message.id }}">
                                {% if message.user != user %}
                                    <div class="d-flex align-items-center mb-1">
                                        {% if message.user.profile.profile_photo %}
                                            <img src="{{ message.user.profile.profile_photo.url }}" 
                                                 class="rounded-circle me-2" style="width: 20px; height: 20px;" alt="Avatar">
                                        {% endif %}
                                        <small class="text-muted fw-bold">{{ message.user.username }}</small>
                                    </div>
                                {% endif %}
                                
                                <!-- Message Content -->
                                <div class="message-content">
                                    {% if message.is_deleted %}
                                        <em class="text-muted">{{ message.content }}</em>
                                    {% elif message.message_type == 'TEXT' %}
                                        {{ message.content }}
                                    {% elif message.message_type == 'IMAGE' %}
                                        <div class="message-image">
                                            <img src="{{ message.image.url }}" class="img-fluid rounded" 
                                                 style="max-width: 300px; max-height: 200px; cursor: pointer;"
                                                 onclick="showImageModal('{{ message.image.url }}', '{{ message.user.username }}')" alt="Image">
                                                 {% if message.content %}
                                                <div class="mt-2">{{ message.content }}</div>
                                            {% endif %}
                                        </div>
                                    {% elif message.message_type == 'FILE' %}
                                        <div class="message-file">
                                            <i class="fas fa-file me-2"></i>
                                            <a href="{{ message.file.url }}" download class="text-decoration-none">
                                                {{ message.file.name|slice:"13:" }}
                                            </a>
                                            <small class="text-muted d-block">
                                                {{ message.file.size|filesizeformat }}
                                            </small>
                                            {% if message.content %}
                                                <div class="mt-2">{{ message.content }}</div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="message-footer d-flex align-items-center justify-content-between">
                                    <small class="text-muted message-time">
                                        {{ message.timestamp|date:"H:i" }}
                                        {% if message.edited %}
                                            <i class="fas fa-edit ms-1" title="Edited"></i>
                                        {% endif %}
                                    </small>
                                    
                                    <!-- Read Receipt for own messages in rooms -->
                                    {% if message.user == user and not message.is_deleted %}
                                        <div class="read-receipt">
                                            {% with read_count=message.read_receipts.count %}
                                                {% if read_count > 0 %}
                                                    <i class="fas fa-check-double text-primary" title="Read by {{ read_count }} member{{ read_count|pluralize }}"></i>
                                                    {% if read_count > 1 %}
                                                        <small class="text-muted">{{ read_count }}</small>
                                                    {% endif %}
                                                {% else %}
                                                    <i class="fas fa-check text-muted" title="Sent"></i>
                                                {% endif %}
                                            {% endwith %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                {% if message.user == user and not message.is_deleted %}
                                    <div class="message-actions" style="display: none;">
                                        {% if message.message_type == 'TEXT' %}
                                            <button class="btn btn-xs btn-outline-secondary me-1" 
                                                    onclick="editMessage('{{ message.id }}', '{{ message.content|escapejs }}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-xs btn-outline-danger" 
                                                onclick="deleteMessage('{{ message.id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No messages yet. Start the conversation!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Message Input -->
            <div class="card-footer bg-transparent">
                <form id="message-form" class="d-flex align-items-center" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="type" value="room">
                    <input type="hidden" name="room_id" value="{{ room.id }}">
                    
                    <!-- File attachments (hidden inputs) -->
                    <input type="file" id="image-input" name="image" accept="image/*" style="display: none;" onchange="handleFileSelect('image')">
                    <input type="file" id="file-input" name="file" style="display: none;" onchange="handleFileSelect('file')">
                    
                    <!-- Attachment buttons with improved mobile layout -->
                    <div class="attachment-buttons me-2 d-flex">
                        <button type="button" class="btn btn-outline-secondary btn-sm attachment-btn" onclick="document.getElementById('image-input').click()" title="Send Image">
                            <i class="fas fa-image"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm attachment-btn" onclick="document.getElementById('file-input').click()" title="Send File">
                            <i class="fas fa-paperclip"></i>
                        </button>
                    </div>
                    
                    <!-- File preview area -->
                    <div id="file-preview" class="me-2" style="display: none;">
                        <div class="d-flex align-items-center bg-light rounded p-2">
                            <span id="file-name" class="small me-2"></span>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFileSelection()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-grow-1 me-2">
                        <div class="input-group">
                            <input type="text" class="form-control" name="content" 
                                   placeholder="Type your message..." autocomplete="off">
                            <button type="submit" class="btn btn-custom">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- All modals remain the same as in your original template -->
<!-- Members Modal -->
<div class="modal fade" id="membersModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2"></i>Room Members ({{ room.participants.count }})
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% for participant in room.participants.all %}
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        {% if participant.user.profile.profile_photo %}
                            <img src="{{ participant.user.profile.profile_photo.url }}" 
                                 class="user-avatar" alt="Avatar">
                        {% else %}
                            <div class="user-avatar bg-primary d-flex align-items-center justify-content-center text-white">
                                {{ participant.user.username|first|upper }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            {{ participant.user.get_full_name|default:participant.user.username }}
                            {% if participant.user == room.creator %}
                                <span class="badge bg-success ms-2">Creator</span>
                            {% elif participant.role == 'admin' %}
                                <span class="badge bg-primary ms-2">Admin</span>
                            {% elif participant.role == 'moderator' %}
                                <span class="badge bg-warning ms-2">Moderator</span>
                            {% endif %}
                        </h6>
                        <small class="text-muted">
                            {% if participant.user.profile.online %}
                                <i class="fas fa-circle text-success me-1"></i>Online
                            {% else %}
                                Last seen {{ participant.user.profile.last_activity|timesince }} ago
                            {% endif %}
                        </small>
                    </div>
                    {% if participant.user != user %}
                        <a href="{% url 'private_chat' participant.user.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-comment"></i>
                        </a>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Other modals remain the same from your original template -->
<!-- Invite Users Modal, Image Modal, Edit Message Modal -->

{% endblock %}

{% block extra_css %}
<style>
    /* Same styles as private chat template plus room-specific styles */
    .message-bubble {
        position: relative;
        margin-bottom: 15px;
    }

    .message-bubble:hover .message-actions {
        display: block !important;
    }

    .message-actions {
        position: absolute;
        top: 5px;
        right: 10px;
    }

    .btn-xs {
        padding: 2px 5px;
        font-size: 0.75rem;
    }

    #messages-container {
        scroll-behavior: smooth;
        overflow-y: auto;
    }
    
    /* Date header styles */
    .date-header {
        text-align: center;
        margin: 20px 0;
        position: relative;
    }
    
    .date-header::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #dee2e6;
        z-index: 1;
    }
    
    .date-label {
        background: white;
        padding: 5px 15px;
        color: #6c757d;
        font-size: 0.875rem;
        font-weight: 500;
        position: relative;
        z-index: 2;
        border-radius: 15px;
        border: 1px solid #dee2e6;
    }
    
    /* Message footer styles */
    .message-footer {
        margin-top: 5px;
    }
    
    /* Read receipt styles for rooms */
    .read-receipt {
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 2px;
    }
    
    .read-receipt .fa-check-double {
        color: #0d6efd;
    }
    
    .read-receipt .fa-check {
        color: #6c757d;
    }
    
    /* Room icon styles */
    .room-icon-private {
        background-color: #ffc107 !important;
    }

    .room-icon-public {
        background-color: #0d6efd !important;
    }
    
    /* File preview styles */
    .message-image img {
        border-radius: 8px;
    }
    
    .message-file {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        border-left: 4px solid #0d6efd;
    }

    /* Deleted message styles */
    .message-deleted {
        opacity: 0.6;
    }

    .message-deleted .message-content {
        font-style: italic;
        color: #6c757d;
    }
    
    /* Loading indicator */
    #loading-indicator {
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
        border-bottom: 1px solid #dee2e6;
    }
    
    /* Mobile responsive styles */
    @media (max-width: 480px) {
        .date-label {
            padding: 3px 10px;
            font-size: 0.75rem;
        }
        
        .read-receipt {
            font-size: 0.7rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Same JavaScript as private chat template with room-specific modifications
let isAtBottom = true;
let currentPage = 1;
let isLoading = false;
let hasMoreMessages = true;
let selectedUsers = new Set();

$(document).ready(function() {
    // Scroll to bottom initially
    scrollToBottom();
    
    // Check if user is at bottom when scrolling
    const container = $('#messages-container')[0];
    $(container).on('scroll', function() {
        isAtBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 1;
        
        // Load more messages when scrolling to top
        if (container.scrollTop === 0 && hasMoreMessages && !isLoading) {
            loadMoreMessages();
        }
    });
    
    // Handle message form submission
    $('#message-form').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const content = formData.get('content');
        const hasFile = formData.get('image') && formData.get('image').size > 0;
        const hasAttachment = formData.get('file') && formData.get('file').size > 0;
        
        if (!content.trim() && !hasFile && !hasAttachment) {
            return;
        }
        
        // Show loading state
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);
        
        $.ajax({
            url: '{% url "send_message" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    // Add message to UI
                    addMessageToUI(response, true);
                    // Clear form
                    $('#message-form input[name="content"]').val('');
                    clearFileSelection();
                } else {
                    alert('Error sending message: ' + response.message);
                }
            },
            error: function() {
                alert('Error sending message. Please try again.');
            },
            complete: function() {
                // Reset button state
                submitBtn.html(originalText).prop('disabled', false);
                // Focus back to input
                $('#message-form input[name="content"]').focus();
            }
        });
    });
    
    // Auto-refresh messages every 5 seconds
    setInterval(refreshMessages, 5000);
    
    // User search on enter
    $('#user-search-input').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            searchUsers();
        }
    });
});

// Include all the same functions from private chat template with room-specific modifications
function loadMoreMessages() {
    if (isLoading || !hasMoreMessages) return;
    
    isLoading = true;
    $('#loading-indicator').show();
    
    currentPage++;
    
    $.get('{% url "get_room_messages" room.id %}', {
        page: currentPage,
        limit: 20
    }, function(data) {
        if (data.messages && data.messages.length > 0) {
            const container = $('#messages-container');
            const scrollHeight = container[0].scrollHeight;
            
            // Add messages to top
            data.messages.reverse().forEach(function(item) {
                if (item.type === 'date_header') {
                    addDateHeaderToUI(item, true);
                } else {
                    addMessageToUI(item, false, true);
                }
            });
            
            // Maintain scroll position
            const newScrollHeight = container[0].scrollHeight;
            container[0].scrollTop = newScrollHeight - scrollHeight;
            
            hasMoreMessages = data.has_more;
        } else {
            hasMoreMessages = false;
        }
    }).fail(function() {
        currentPage--; // Revert page increment on failure
        alert('Error loading messages');
    }).always(function() {
        isLoading = false;
        $('#loading-indicator').hide();
    });
}

function addMessageToUI(messageData, isOwn, prepend = false) {
    const messageClass = isOwn ? 'message-own' : 'message-other';
    const userInfo = isOwn ? '' : `
        <div class="d-flex align-items-center mb-1">
            <small class="text-muted fw-bold">${messageData.username}</small>
        </div>
    `;
    
    let messageContent = '';
    if (messageData.message_type === 'IMAGE') {
        messageContent = `
            <div class="message-image">
                <img src="${messageData.file_url}" class="img-fluid rounded" 
                     style="max-width: 300px; max-height: 200px; cursor: pointer;"
                     onclick="showImageModal('${messageData.file_url}', '${messageData.username}')" alt="Image">
                ${messageData.content ? `<div class="mt-2">${messageData.content}</div>` : ''}
            </div>
        `;
    } else if (messageData.message_type === 'FILE') {
        messageContent = `
            <div class="message-file">
                <i class="fas fa-file me-2"></i>
                <a href="${messageData.file_url}" download class="text-decoration-none">
                    ${messageData.file_name}
                </a>
                ${messageData.content ? `<div class="mt-2">${messageData.content}</div>` : ''}
            </div>
        `;
    } else {
        messageContent = messageData.content;
    }
    
    // Read receipt indicator for own messages in rooms
    let readReceipt = '';
    if (isOwn) {
        const readCount = messageData.read_count || 0;
        if (readCount > 0) {
            readReceipt = `
                <div class="read-receipt">
                    <i class="fas fa-check-double text-primary" title="Read by ${readCount} member${readCount > 1 ? 's' : ''}"></i>
                    ${readCount > 1 ? `<small class="text-muted">${readCount}</small>` : ''}
                </div>
            `;
        } else {
            readReceipt = '<div class="read-receipt"><i class="fas fa-check text-muted" title="Sent"></i></div>';
        }
    }
    
    const messageActions = isOwn ? `
        <div class="message-actions" style="display: none;">
            ${messageData.message_type === 'TEXT' ? `
                <button class="btn btn-xs btn-outline-secondary me-1" 
                        onclick="editMessage('${messageData.message_id || messageData.id}', '${messageData.content ? messageData.content.replace(/'/g, "\\'") : ''}')">
                    <i class="fas fa-edit"></i>
                </button>
            ` : ''}
            <button class="btn btn-xs btn-outline-danger" 
                    onclick="deleteMessage('${messageData.message_id || messageData.id}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    ` : '';
    
    const messageHTML = `
        <div class="message-bubble ${messageClass}" data-message-id="${messageData.message_id || messageData.id}">
            ${userInfo}
            <div class="message-content">${messageContent}</div>
            <div class="message-footer d-flex align-items-center justify-content-between">
                <small class="text-muted message-time">
                    ${messageData.formatted_time || messageData.timestamp}
                    ${messageData.edited ? '<i class="fas fa-edit ms-1" title="Edited"></i>' : ''}
                </small>
                ${readReceipt}
            </div>
            ${messageActions}
        </div>
    `;
    
    if (prepend) {
        $('#messages-container').prepend(messageHTML);
    } else {
        $('#messages-container').append(messageHTML);
        
        if (isAtBottom) {
            scrollToBottom();
        }
    }
}

// Include all other functions from private chat (scrollToBottom, refreshMessages, etc.)
// ... (same functions as private chat template)
</script>
{% endblock %}